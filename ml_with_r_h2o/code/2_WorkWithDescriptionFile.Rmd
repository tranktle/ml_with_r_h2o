---
title: "2_Work_with_Description_File"
author: "Tran Le"
date: "8/22/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    # code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse=TRUE, comment=">>")
library(tidyverse)
library(dplyr)
```

```{r klippy, echo=FALSE}
klippy::klippy(position = c("top", "right"), tooltip_message = "Copy code")  #to insert a copy to clipboard buttons in HTML document https://github.com/RLesur/klippy
```



# Introduction

The purpose of this file is showing how to use data_description.txt to find the list of characteristics columns that contain "NA" as inputs. The NAs here do not mean missing values but "contain None", for example, a house that has no Basement. We will do this in two steps: 

1. We want to create a tibble from the description file. \
2. Names of the columns having "NA" meaning "None".

Here are the two functions that you can do for the the two steps. Read the next section incase you want the explaination of steps using in each function.

## A Function to create a tibble from description file.

```{r}
create_descrip_tibble_f <- function(){
  # Step 1: Create a tibble
  des_file <- read_lines("../house_dat/data_description.txt",
                         skip_empty_rows = TRUE)
  
  header <- c("name\tdescription\n")
  des_file <- str_c(header, des_file)
  
  des_file_new <- suppressWarnings(read_delim(des_file, delim = "\t")) %>% 
                  filter(name != "name") %>%
                  mutate_if(is.character, str_trim)  
  
  des_file <- des_file_new %>% mutate(index = 1:nrow(des_file_new))
  
  # Step2: Create num_fac, a column that distinguish which row is a numerical/factorial columns or factor levels
  # Find the indexes of columns
  col_index <- filter(des_file, grepl(':', name)) %>% pull(index)

  # Find indexes of numerical columns
  lag_diff <- diff(col_index, lag = 1, differences = 1)
  is_num_col <- (1==lag_diff)
  num_col_index <-  col_index[is_num_col]
  
   # Find the indexes of catergorical columns
   char_col_index <-  col_index[!is_num_col]
   # Add a column named num_fac to distingush between numeical, factorial column or factor_level_values

   des_file <- des_file %>% 
              mutate(num_fac = case_when(
                     index %in% num_col_index ~ "num_col", 
                     index %in% char_col_index ~ "fac_col", 
                     TRUE                      ~ "fac_val")) %>%
              select(index, everything())  #to put index column in the first column
   # Step 3: Correct the columnnames:description to put them into separated "name" and "description" columns 
   work_with_col_name<- des_file %>% filter(index %in% col_index) %>%
                    separate(col = name, into =c("name", "description"), sep=":") 
  des_file <- rbind(des_file %>% filter(num_fac =="fac_val"), work_with_col_name) %>%
            arrange(index)
  
  return(des_file)
}

```

```{r}
des_file <- create_descrip_tibble_f()
des_file
```


## A function to exclude the column names having NA means None

```{r}

find_col_name_f <- function(des_tibble){
  #Find the index values of rows having NA means "None"
  Na_index <- des_file %>% filter(name =="NA") %>% pull(index) 

  #Filter the row index of column names
  Col_index <- des_file %>% filter(num_fac=="fac_col") %>% pull(index)

  # Find indexes of columns that contains NA means "None"
  Col_contain_Na_index <- c()
  for (i in Na_index){
    Col_contain_Na_index <- append(Col_contain_Na_index,max(Col_index[Col_index < i]) )}
  # Take names of columns that contains NA means "None" based on it indexes
  Thecolname <- des_file %>% filter(index %in% Col_contain_Na_index) %>% pull(name)
  return(Thecolname)
}
```

```{r}
(Thecolname <- find_col_name_f(des_tibble))
```



# Explain the two functions above

## Explain the steps of creating a description tibble from data_description.txt file

### Step 1: Create a temprorary tibble, this tibble will be modified later on

First, using read_lines to read the data_description.txt file. We see that the column names are in the rows having ":" that seperate column names and columns' description. The factor names are seperated with their desciption by "\t"
```{r}
des_file <- read_lines("../house_dat/data_description.txt", skip_empty_rows = TRUE)
head(des_file)
```

We will want to make a tibble. Note that tibbles are dataframes, but they tweak some older behaviours to make life a little easier ([Read about tibble from here](https://r4ds.had.co.nz/tibbles.html))

The tibble created will have name and description columns. We, therefore, want to add the column names (name, description) to the data. 

```{r, warning=FALSE}
header <- c("name\tdescription\n")
new_discription_file <- str_c(header, des_file)
head(new_discription_file)
```

Now, we will use read_delim to make a tibble, then the next step we will want to delete the extra rows that have name=="names"
```{r, warning=FALSE}
#use read_delim to make a tibble
new_discription_file <- read_delim(new_discription_file, delim = "\t")
head(new_discription_file)
```
Now, we want to remove rows with values are ("name", "description"). Also, we want to trim the whitespaces of before and after strings in the data. The last thing we do in this step is to add index to the tiblle, we will use the index to find the index of values NA (means None) and also find index of the columns having those values NA (means None)
```{r, warning=FALSE}
new_discription_file <- new_discription_file %>% filter(name != "name")  %>%
                        mutate_if(is.character, str_trim) 
des_file <- new_discription_file  %>% mutate(index = 1: nrow(new_discription_file))
head(des_file)
```

### Step 2: Create a num_fac that have values in $\{"num_col", "fac_col","fac_val")\}$ which means the associative row is a name of $\{a numerical column, a factorial column, a factor level value\}$

- Find the column indexes of all column in the description file 
```{r}
col_index <- filter(des_file, grepl(':', name)) %>% pull(index)
cat("col_index: \n", col_index, "\n")
```

- Find if the column in the description files are numerical or factorial columns: we will find indexes of those columns

We find the numerical columns by using Col_index indexes from the des_file indexes of numerical columns are the rows in the description file that are followed by index of another column (not factor_level). In the below, they are the rows in des_file  having lag_diff=1
```{r}
lag_diff <- diff(col_index, lag = 1, differences = 1)
cat("lag_diff: ", lag_diff, "\n \n")
is_num_col <- (1==lag_diff)
num_col_index <-  col_index[is_num_col]
cat("num_col_index:\n", num_col_index, "\n")
```
 
The characteristic columns are just the ones which are not numerical columns :)
```{r}
char_col_index <-  col_index[!is_num_col]
```
Now, we want to add a column named num_fac to distingush between numeical or factorial column, num_fac = 1 if is a numerical column and num_fac = 0 if is a factorial column

```{r, warning = TRUE}
des_file <- des_file %>% 
  mutate(num_fac = case_when(
                              index %in% num_col_index ~ "num_col", 
                              index %in% char_col_index ~ "fac_col", 
                              TRUE                      ~ "fac_val")) %>%
  select(index, everything())  #to put index column in the first column
head(des_file) 
```

### Separate name and description of data's columns 

First, we will filter the rows that contain column names and their descriptions , we put the decription of the (numerical and factorial) columns in to the place that it should be and combind it back to the des_file
```{r, warning=TRUE}
work_with_col_name<- des_file %>% filter(index %in% col_index) %>%
                    separate(col = name, into =c("name", "description"), sep=":") 
head(work_with_col_name)
```

```{r}
des_file <- rbind(des_file %>% filter(num_fac =="fac_val"), work_with_col_name) %>%
            arrange(index)
head(des_file)
```

```{r}
des_file
```

## Step 2: Find the index of columns having values NA means "None"

Find the index values of rows having NA means "None"
```{r}
Na_index <- des_file %>% filter(name =="NA") %>% pull(index) 
Na_index
```
Filter the row index of column names
```{r}
Col_index <- des_file %>% filter(num_fac=="fac_col") %>% pull(index)
Col_index
```

The column index of a column that contains NA are the first ones that is smaller than the Na_index 

```{r}
Col_contain_Na <- c()
for (i in Na_index){
  Col_contain_Na <- append(Col_contain_Na,max(Col_index[Col_index < i]) )
}
Col_contain_Na
```

So, now we only need to print the columns names that contains NA based on it indexes

```{r, warning=FALSE}
Thecolname <- des_file %>% filter(index %in% Col_contain_Na) %>% select(name)

Thecolname
```


https://alistaire.rbind.io/blog/coalescing-joins/